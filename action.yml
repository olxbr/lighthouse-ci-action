name: "Lighthouse CI Action"
description: "Audit URLs using Lighthouse and test performance with Lighthouse CI"
inputs:
  urls:
    description: "List of URL(s) to analyze"
  budgetPath:
    description: "Path to a Lighthouse budgets.json file"
  configPath:
    description: "Path to a LHCI lighthouserc.json file"
  uploadArtifacts:
    description: "Opt-out of saving Lighthouse results as an action artifacts"
  artifactName:
    description: "Name of the artifact group if using uploadArtifacts. default: lighthouse-results"
    default: lighthouse-results
  temporaryPublicStorage:
    description: "Opt-in to saving Lighthouse results to temporary public storage"
  runs:
    description: "Number of runs to do per URL"
  serverBaseUrl:
    description: "Address of a LHCI server"
  serverToken:
    description: "API token to push to LHCI server"
  basicAuthUsername:
    description: "Basic auth username for LHCI server"
  basicAuthPassword:
    description: "Basic auth password for LHCI server"
  gh_token:
    description: "PAT to comment on PR"
  comment_on_pr:
    default: true
    description: "Boolean to define if will comment on PR or not"
outputs:
  resultsPath:
    description: "Path to the folder with LHCI results"
    value: ${{ steps.treosh-lhci-action.outputs.resultsPath }}
  links:
    description: "Links to compare/result UI for each URL (content of links.json)"
    value: ${{ steps.treosh-lhci-action.outputs.links }}
  assertionResults:
    description: "Assertion results (content of assertion-results.json)"
    value: ${{ steps.treosh-lhci-action.outputs.assertionResults }}
runs:
  using: "composite"
  steps:
    - name: Treosh Lighthouse CI Action
      id: treosh-lhci-action
      uses: treosh/lighthouse-ci-action@v9
      with:
        urls: ${{ inputs.urls }}
        budgetPath: ${{ inputs.budgetPath }}
        configPath: ${{ inputs.configPath }}
        uploadArtifacts: ${{ inputs.uploadArtifacts }}
        artifactName: ${{ inputs.artifactName }}
        temporaryPublicStorage: ${{ inputs.temporaryPublicStorage }}
        runs: ${{ inputs.runs }}
        serverBaseUrl: ${{ inputs.serverBaseUrl }}
        serverToken: ${{ inputs.serverToken }}
        basicAuthUsername: ${{ inputs.basicAuthUsername }}
        basicAuthPassword: ${{ inputs.basicAuthPassword }}
    - name: Print outputs
      shell: bash
      run: |

        ## Load json to print metrics
        JSON='${{ steps.treosh-lhci-action.outputs.manifest }}'
        
        ## Load common functions
        source ${{github.action_path}}/scripts/utils.sh
        
        cmd_calc_avg="awk '{ sum+=$1; qtd+=1 } END {print (sum/qtd)}'"

        _log "#########################"
        _log "### Average of ${C_WHT}${{ inputs.runs }}${C_END} runs ###"
        _log "#########################"

        ## Summary (AVG)
        avg_performance=$(eval jq -r '.[].summary.performance'         <<< $JSON | $cmd_calc_avg || echo '-')
        avg_accessibility=$(eval jq -r '.[].summary.accessibility'     <<< $JSON | $cmd_calc_avg || echo '-')
        avg_best_practices=$(eval jq -r '.[].summary."best-practices"' <<< $JSON | $cmd_calc_avg || echo '-')
        avg_seo=$(eval jq -r '.[].summary.seo'                         <<< $JSON | $cmd_calc_avg || echo '-')
        avg_pwa=$(eval jq -r '.[].summary.pwa'                         <<< $JSON | $cmd_calc_avg || echo '-')
        
        _log "ðŸ…¢ Summary"
        _log "â€‰â€‰â€‰â”œâŽ¯âŽ¯Performance: $(_summaryColor $avg_performance)"
        _log "â€‰â€‰â€‰â”œâŽ¯âŽ¯Accessibility: $(_summaryColor $avg_accessibility)"
        _log "â€‰â€‰â€‰â”œâŽ¯âŽ¯Best practices: $(_summaryColor $avg_best_practices)"
        _log "â€‰â€‰â€‰â”œâŽ¯âŽ¯SEO: $(_summaryColor $avg_seo)"
        _log "â€‰â€‰â€‰â””âŽ¯âŽ¯PWA: $(_summaryColor $avg_pwa)"

        ## Metrics (AVG)
        list_json_path=$(jq -r '.[].jsonPath' <<< $JSON)
        list_metrics_name='firstContentfulPaint largestContentfulPaint interactive speedIndex totalBlockingTime totalCumulativeLayoutShift'

        _log "Get info from files ${list_json_path}..."
          
        _log "ðŸ…œ Metrics"
        for metric_name in $list_metrics_name; do
          _log $metric_name
          all_values=$(jq -r ".audits.metrics.details.items[].${metric_name} | select (.!=null)" <<< $(cat $list_json_path))
          avg=$(awk '{ sum+=$1; qtd+=1 } END {print (sum/qtd)*100}' || echo '-')
        done
        
        
        ## Exporting variables
        lighthouse_link=$(jq -r '.[]' <<< '${{ steps.treosh-lhci-action.outputs.links }}')
        echo "lighthouse_link=${lighthouse_link}" >> $GITHUB_ENV
        echo "avg_performance=${avg_performance}" >> $GITHUB_ENV
        echo "avg_accessibility=${avg_accessibility}" >> $GITHUB_ENV
        echo "avg_best_practices=${avg_best_practices}" >> $GITHUB_ENV
        echo "avg_seo=${avg_seo}" >> $GITHUB_ENV
        echo "avg_pwa=${avg_pwa}" >> $GITHUB_ENV


    - name: Comment on PR
      if: ${{ inputs.comment_on_pr }}
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.gh_token }}
        PR_NUMBER: ${{ github.event.number }}
      run: |
        ## Comment on PR if necessary
        cd ${{github.action_path}}
        bash scripts/post_pr_comment.sh
